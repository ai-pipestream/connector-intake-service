# Connector-Intake Service Configuration
quarkus.application.name=connector-intake
quarkus.application.version=1.0.0-SNAPSHOT

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Connector-intake service port (38108)
quarkus.http.host=0.0.0.0
quarkus.http.port=38108
# Use separate gRPC server (Netty-based) - REQUIRED for HTTP/2 flow control window tuning
# Unified server mode (use-separate-server=false) does NOT support HTTP/2 flow control window configuration
# Separate server mode provides full control and proven 250-370 MB/s throughput
# The GrpcServerFlowControlCustomizer from dynamic-grpc package will automatically apply flow control settings
# See dynamic-grpc/UNIFIED_SERVER_LIMITATIONS.md for details

# gRPC Flow Control - 100MB window for better throughput with large messages
quarkus.grpc.server.flow-control-window=104857600
quarkus.grpc.server.max-outbound-message-size=2147483647

# Set gRPC client flow control for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=104857600

# ======================================================================================================================
# Vert.x / Netty Performance Tuning for High Throughput gRPC
# ======================================================================================================================
# Increase event loop threads for better concurrency
quarkus.vertx.event-loops-pool-size=8

# Netty buffer sizes - critical for large message throughput
# Prefer native transport for better performance
quarkus.vertx.prefer-native-transport=true
quarkus.http.io-threads=8

# Dev configuration
%dev.quarkus.http.port=38108
%dev.quarkus.http.root-path=/intake
%dev.quarkus.grpc.server.port=48108

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password
# JDBC URL configured per profile (dev/prod)

# Hibernate configuration
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true
%dev.quarkus.flyway.clean-at-start=true
%dev.quarkus.flyway.validate-on-migrate=false

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.flyway.baseline-on-migrate=true

quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# Note: The quarkus-pipeline-devservices extension extracts the compose file to ~/.pipeline/
# but does NOT configure Quarkus Compose Dev Services automatically. You must add the properties below.

# Dev Services - Disable standalone datasource devservices since we're using Compose Dev Services
%dev.quarkus.datasource.devservices.enabled=true

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
pipestream.registration.service-name=connector-intake
pipestream.registration.description=Connector document ingestion, authentication, metadata enrichment, and rate limiting
pipestream.registration.type=SERVICE
pipestream.registration.capabilities=document-ingestion,metadata-enrichment,rate-limiting
pipestream.registration.tags=connector,intake,core-service
# Pipestream server defaults
pipestream.server.class=core
pipestream.server.capabilities=pipedoc

# Internal host/port for Docker - Consul uses this for health checks
# HTTP Endpoint Registration
pipestream.registration.http.enabled=true
pipestream.registration.http.scheme=${SERVICE_REGISTRATION_HTTP_SCHEME:http}
pipestream.registration.http.base-path=${quarkus.http.root-path:}/api/v1
pipestream.registration.http.tls-enabled=${SERVICE_REGISTRATION_TLS_ENABLED:false}
pipestream.registration.http.schema=${OPENAPI_SCHEMA_URL}
pipestream.registration.http.schema-version=1.0.0
pipestream.registration.http.schema-artifact-id=connector-intake-service-http

# Production profile - use HTTPS and TLS
%prod.pipestream.registration.http.scheme=https
%prod.pipestream.registration.http.tls-enabled=true

# Registration service connection
pipestream.registration.registration-service.host=localhost
pipestream.registration.registration-service.port=38101

%test.pipestream.registration.enabled=false

# ======================================================================================================================
# Connector-Intake Configuration
# ======================================================================================================================
connector-intake.default-rate-limit-per-minute=1000
connector-intake.max-concurrent-streams=100
connector-intake.session-timeout-minutes=60
connector-intake.session-cleanup-interval-minutes=10
connector-intake.chunk-assembly-timeout-minutes=30
connector-intake.max-chunk-size-mb=10
connector-intake.max-document-size-mb=10240
connector-intake.max-filename-length=255

# Repository-service HTTP proxy (raw upload) - discovered via Consul/Stork
connector-intake.repository-upload.raw-path=/internal/uploads/raw
connector-intake.repository-upload.request-timeout=60s
connector-intake.repository-upload.service-name=repository
%dev.connector-intake.repository-upload.base-url=http://localhost:38102/repository
# Stork discovery for repository-service (consul in prod/dev, static in tests via test resources)
stork.repository.service-discovery.type=consul
stork.repository.service-discovery.consul-host=${CONSUL_HOST:localhost}
stork.repository.service-discovery.consul-port=${CONSUL_PORT:8500}

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
# GitHub Container Registry
quarkus.container-image.registry=ghcr.io
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=connector-intake-service
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# ======================================================================================================================
# Quarkus Index Dependencies
# ======================================================================================================================
quarkus.index-dependency.pipestream-registration.group-id=ai.pipestream
quarkus.index-dependency.pipestream-registration.artifact-id=pipestream-service-registration
quarkus.index-dependency.pipestream-dynamic-grpc.group-id=ai.pipestream
quarkus.index-dependency.pipestream-dynamic-grpc.artifact-id=quarkus-dynamic-grpc
