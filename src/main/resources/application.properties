# Connector-Intake Service Configuration
quarkus.application.name=connector-intake-service
quarkus.application.version=1.0.0-SNAPSHOT

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Connector-intake service port (38108)
quarkus.http.host=0.0.0.0
quarkus.http.port=38108
# Use separate gRPC server (Netty-based) - REQUIRED for HTTP/2 flow control window tuning
# Unified server mode (use-separate-server=false) does NOT support HTTP/2 flow control window configuration
# Separate server mode provides full control and proven 250-370 MB/s throughput
# The GrpcServerFlowControlCustomizer from dynamic-grpc package will automatically apply flow control settings
# See dynamic-grpc/UNIFIED_SERVER_LIMITATIONS.md for details
quarkus.grpc.server.use-separate-server=true
quarkus.grpc.server.port=48108
quarkus.grpc.server.enable-health-service=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# gRPC Flow Control - 100MB window for better throughput with large messages
quarkus.grpc.server.flow-control-window=104857600
quarkus.grpc.server.max-outbound-message-size=2147483647

# Set gRPC client flow control for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".max-outbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=104857600

# gRPC Client Configuration - Repository Service
quarkus.grpc.clients.repo-service.host=localhost
quarkus.grpc.clients.repo-service.port=38102
# Explicit settings for repo-service client (overrides wildcard)
quarkus.grpc.clients.repo-service.max-inbound-message-size=2147483647
quarkus.grpc.clients.repo-service.max-outbound-message-size=2147483647
quarkus.grpc.clients.repo-service.flow-control-window=104857600
quarkus.grpc.clients.repo-service.keepalive-time=30s
quarkus.grpc.clients.repo-service.keepalive-timeout=5s
quarkus.grpc.clients.repo-service.permit-keepalive-without-calls=true

# ======================================================================================================================
# Vert.x / Netty Performance Tuning for High Throughput gRPC
# ======================================================================================================================
# Increase event loop threads for better concurrency
quarkus.vertx.event-loops-pool-size=8

# Netty buffer sizes - critical for large message throughput
# Prefer native transport for better performance
quarkus.vertx.prefer-native-transport=true
quarkus.http.io-threads=8

# Dev configuration
%dev.quarkus.http.port=38108
%dev.quarkus.http.root-path=/intake
%dev.quarkus.grpc.server.port=48108

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password

# Hibernate configuration
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true
%dev.quarkus.flyway.validate-on-migrate=false

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.flyway.baseline-on-migrate=true

quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# Note: The quarkus-pipeline-devservices extension extracts the compose file to ~/.pipeline/
# but does NOT configure Quarkus Compose Dev Services automatically. You must add the properties below.

# Compose Dev Services - Enable shared infrastructure for dev mode
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true

# Dev Services - Disable standalone datasource devservices since we're using Compose Dev Services
%dev.quarkus.datasource.devservices.enabled=false

%dev.quarkus.devservices.timeout=120s

# Database configuration for dev mode (using the shared PostgreSQL from compose)
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/pipeline

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
pipestream.registration.service-name=connector-intake-service
pipestream.registration.description=Connector document ingestion, authentication, metadata enrichment, and rate limiting
pipestream.registration.type=SERVICE
pipestream.registration.advertised-host=${CONNECTOR_INTAKE_SERVICE_HOST:host.docker.internal}
pipestream.registration.advertised-port=${quarkus.grpc.server.port}
# Internal host/port for Docker - Consul uses this for health checks
pipestream.registration.internal-host=${DOCKER_BRIDGE_IP:172.17.0.1}
pipestream.registration.internal-port=${quarkus.grpc.server.port}
pipestream.registration.capabilities=document-ingestion,metadata-enrichment,rate-limiting
pipestream.registration.tags=connector,intake,core-service,traefik.enable=true,traefik.http.routers.connector-intake-service.rule=PathPrefix(`/intake`),traefik.http.routers.connector-intake-service.entrypoints=web,traefik.http.middlewares.connector-intake-slash.redirectregex.regex=^/intake$$,traefik.http.middlewares.connector-intake-slash.redirectregex.replacement=/intake/,traefik.http.routers.connector-intake-service.middlewares=connector-intake-slash

# Registration service connection
pipestream.registration.registration-service.host=localhost
pipestream.registration.registration-service.port=38101

%test.pipestream.registration.enabled=false

# ======================================================================================================================
# Connector-Intake Configuration
# ======================================================================================================================
connector-intake.default-rate-limit-per-minute=1000
connector-intake.max-concurrent-streams=100
connector-intake.session-timeout-minutes=60
connector-intake.session-cleanup-interval-minutes=10
connector-intake.chunk-assembly-timeout-minutes=30
connector-intake.max-chunk-size-mb=10
connector-intake.max-document-size-mb=10240
connector-intake.max-filename-length=255

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
# GitHub Container Registry
quarkus.container-image.registry=ghcr.io
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=connector-intake-service
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# ======================================================================================================================
# Quarkus Index Dependencies
# ======================================================================================================================
quarkus.index-dependency.pipestream-registration.group-id=ai.pipestream
quarkus.index-dependency.pipestream-registration.artifact-id=pipestream-service-registration
quarkus.index-dependency.pipestream-dynamic-grpc.group-id=ai.pipestream
quarkus.index-dependency.pipestream-dynamic-grpc.artifact-id=quarkus-dynamic-grpc

