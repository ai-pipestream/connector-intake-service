# DISABLE in-process gRPC - use real Netty channels for proper flow control
quarkus.grpc.server.in-process.enabled=false
quarkus.grpc.clients.repo-service.in-process.enabled=false
quarkus.grpc.clients.connector-intake-service.in-process.enabled=false

# Use random port for test HTTP server and a SEPARATE gRPC server (best performance)
quarkus.http.test-port=0
quarkus.grpc.server.use-separate-server=true
quarkus.grpc.server.test-port=0

# Configure test gRPC clients to connect to the Quarkus test gRPC port (separate gRPC server)
%test.quarkus.grpc.clients.connector-intake-service.host=localhost
%test.quarkus.grpc.clients.connector-intake-service.port=${quarkus.grpc.server.test-port}

# gRPC Performance Settings for Tests - Match production settings
quarkus.grpc.server.max-inbound-message-size=2147483647
quarkus.grpc.server.max-outbound-message-size=2147483647
quarkus.grpc.server.flow-control-window=104857600
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".max-outbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=104857600
quarkus.grpc.clients.repo-service.max-inbound-message-size=2147483647
quarkus.grpc.clients.repo-service.max-outbound-message-size=2147483647
quarkus.grpc.clients.repo-service.flow-control-window=104857600

# dynamic-grpc library uses quarkus.grpc.clients.* properties (see above)

# Vert.x/Netty performance settings for tests
quarkus.vertx.event-loops-pool-size=8
quarkus.vertx.prefer-native-transport=true
quarkus.http.io-threads=8

# Stork/HTTP fallback for repository in tests (MockRepositoryService runs in-process)
%test.quarkus.stork.repository.service-discovery.type=static
%test.quarkus.stork.repository.service-discovery.address-list=localhost:${quarkus.grpc.server.test-port}
%test.connector-intake.repository-upload.base-url=http://localhost:${quarkus.http.test-port}/repository
%test.quarkus.grpc.clients.repository.host=localhost
%test.quarkus.grpc.clients.repository.port=${quarkus.grpc.server.test-port}
%test.quarkus.grpc.clients.repository.in-process.enabled=true

# Keep test logs readable (enable DEBUG ad-hoc when needed)
quarkus.log.category."ai.pipeline.connector.intake".level=INFO
quarkus.log.category."io.grpc".level=INFO
quarkus.log.category."io.netty".level=WARN
quarkus.log.category."io.vertx".level=WARN
quarkus.log.category."io.quarkus.grpc".level=INFO

# Re-enable Dev Services to allow app to start (Hibernate requirement)
quarkus.datasource.devservices.enabled=true
quarkus.compose.devservices.enabled=true
